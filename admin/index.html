<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Red Stampación - Dashboard (Completo)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --------- Paleta y reset --------- */
    :root{
      --red:#c62828; --red-dark:#b71c1c; --bg:#f4f5f7; --card:#ffffff;
      --muted:#9aa3ad; --shadow: 0 6px 18px rgba(14,20,25,0.06);
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:var(--bg); color:#222}
    a{color:inherit;text-decoration:none}

    /* --------- Layout --------- */
    .app {
      display:flex;
      min-height:100vh;
      gap:20px;
    }

    /* Sidebar */
    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--red),var(--red-dark));
      color:#fff;
      padding:28px 18px;
      display:flex;
      flex-direction:column;
      gap:18px;
      box-shadow: 4px 0 18px rgba(0,0,0,0.05);
    }
    .brand{font-weight:800; font-size:20px; letter-spacing:0.3px; text-align:center}
    .sidebar .user-mini{font-size:13px; opacity:0.95; text-align:center}
    .nav{list-style:none;padding:0;margin:6px 0 0}
    .nav li{padding:12px 14px;border-radius:8px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:10px}
    .nav li:hover, .nav li.active{background:rgba(0,0,0,0.08)}
    .nav li .dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.18)}

    .sidebar-footer{margin-top:auto;font-size:12px;opacity:0.95}

    /* Main area */
    .main {
      flex:1;
      padding:22px 28px;
      overflow:auto;
    }

    /* Header */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .search {
      display:flex;align-items:center;background:#fff;padding:8px 12px;border-radius:8px;box-shadow:var(--shadow);gap:8px;width:420px;
    }
    .search input{border:0;outline:none;font-size:14px;width:100%}
    .top-actions{display:flex;gap:10px;align-items:center}
    .avatar{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#fff4f4,#ffd6d6);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--red)}
    .icon-btn{background:#fff;padding:8px;border-radius:8px;box-shadow:var(--shadow);cursor:pointer}

    /* Cards */
    .cards{display:flex;gap:14px;margin-top:18px;flex-wrap:wrap}
    .card {
      background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);flex:1;min-width:200px;border-left:6px solid var(--red);
    }
    .card h4{margin:0;color:#666;font-size:13px}
    .card p{margin:6px 0 0;font-size:20px;font-weight:700}

    /* Chart */
    .panel{background:var(--card);padding:16px;border-radius:12px;margin-top:18px;box-shadow:var(--shadow)}
    .panel h3{margin:0 0 12px}

    /* Table area */
    .table-ctr{margin-top:14px}
    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden;box-shadow:var(--shadow)}
    thead tr{background:#fafafa}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #f1f3f4;font-size:14px}
    td.actions{display:flex;gap:8px}

    /* Buttons */
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--red);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6e6e6}
    .btn.danger{background:#e74c3c;color:#fff}

    /* Controls row */
    .controls{display:flex;align-items:center;gap:10px;margin:12px 0}

    /* Modal */
    .modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:60}
    .modal{width:640px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 30px 60px rgba(2,6,23,0.3)}
    .modal h3{margin:0 0 8px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .form-grid input, .form-grid select, textarea{padding:10px;border-radius:8px;border:1px solid #e9eef1;font-size:14px;width:100%}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Imagen preview small */
    .thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;border:1px solid #eee}

    /* small viewport */
    @media(max-width:920px){
      .search{width:220px}
      .form-grid{grid-template-columns:1fr}
      .modal{width:92%}
      .sidebar{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="sidebar">
      <div class="brand">Red Stampación</div>
      <div class="user-mini">Panel administrador</div>

      <ul class="nav" id="menu">
        <li class="active" data-section="dashboard"><span class="dot"></span> Dashboard</li>
        <li data-section="pedidos"><span class="dot"></span> Pedidos</li>
        <li data-section="inventario"><span class="dot"></span> Inventario</li>
        <li data-section="clientes"><span class="dot"></span> Clientes</li>
        <li data-section="disenos"><span class="dot"></span> Diseños</li>
        <li data-section="reportes"><span class="dot"></span> Reportes</li>
      </ul>

      <div class="sidebar-footer">Guardado en: <strong>localStorage</strong></div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="main">
      <!-- Header Top -->
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#b1b7bb" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6.2" stroke="#b1b7bb" stroke-width="1.6"/></svg>
            <input id="globalSearch" placeholder="Buscar..." />
          </div>
          <div style="font-weight:700;font-size:20px">Dashboard</div>
        </div>

        <div class="top-actions">
          <div class="icon-btn" id="btnExport">Exportar</div>
          <div class="icon-btn" id="btnReset">Reset</div>
          <div class="avatar">RS</div>
        </div>
      </div>

      <!-- Cards -->
      <div class="cards" id="cardsRow">
        <!-- se rellenan por JS -->
      </div>

      <!-- Chart panel -->
      <div class="panel">
        <h3>Ventas mensuales</h3>
        <canvas id="chartVentas" height="90"></canvas>
      </div>

      <!-- Dynamic section area -->
      <div id="sectionArea" class="table-ctr">
        <!-- se inyectará contenido según sección -->
      </div>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" id="modal">
      <h3 id="modalTitle">Título</h3>
      <div id="modalContent"></div>
      <div class="actions">
        <button class="btn ghost" id="modalCancel">Cancelar</button>
        <button class="btn primary" id="modalSave">Guardar</button>
      </div>
    </div>
  </div>

  <script>
  /* ================== Datos y almacenamiento ================== */
  const STORAGE_KEY = 'redstamp_dashboard_v2';

  // ID generator
  const genId = () => 'id_' + Math.random().toString(36).slice(2,9);

  // Inicial seed (si no existe)
  function seedIfEmpty(){
    if(!localStorage.getItem(STORAGE_KEY)){
      const seed = {
        pedidos: [
          { id: genId(), cliente: 'Juan Pérez', producto: 'Camiseta blanca', total: 450000, estado: 'Entregado', fecha: new Date().toISOString().slice(0,10) },
          { id: genId(), cliente: 'María Gómez', producto: 'Taza personalizada', total: 380000, estado: 'Pendiente', fecha: new Date().toISOString().slice(0,10) }
        ],
        inventario: [
          { id: genId(), producto: 'Camiseta blanca', stock: 25, precio: 20000 },
          { id: genId(), producto: 'Taza personalizada', stock: 10, precio: 12000 }
        ],
        clientes: [
          { id: genId(), nombre: 'Juan Pérez', correo: 'juan@example.com', telefono: '3001112222' },
          { id: genId(), nombre: 'María Gómez', correo: 'maria@example.com', telefono: '3103334444' }
        ],
        disenos: [
          // ejemplo: { id, nombre, descripcion, dataUrl }
        ],
        createdAt: new Date().toISOString()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
    }
  }

  function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){ return {}; } }
  function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
  seedIfEmpty();
  let state = loadState();

  /* ================== Helpers UI ================== */
  const menu = document.getElementById('menu');
  const menuItems = menu.querySelectorAll('li');
  const sectionArea = document.getElementById('sectionArea');
  const cardsRow = document.getElementById('cardsRow');
  const globalSearch = document.getElementById('globalSearch');

  // Modal
  const modalBack = document.getElementById('modalBack');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');

  let modalOnSave = null;
  function openModal(title, contentHtml, onSave){
    modalTitle.textContent = title;
    modalContent.innerHTML = contentHtml;
    modalOnSave = onSave;
    modalBack.style.display = 'flex';
  }
  function closeModal(){ modalBack.style.display='none'; modalContent.innerHTML=''; modalOnSave=null; }
  modalCancel.addEventListener('click', closeModal);
  modalBack.addEventListener('click', e => { if(e.target === modalBack) closeModal(); });
  modalSave.addEventListener('click', ()=> { if(typeof modalOnSave === 'function') modalOnSave(); });

  function currency(n){ return '$' + Number(n).toLocaleString(); }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function fechaHoy(){ return new Date().toISOString().slice(0,10); }

  /* ================== NAVIGATION ================== */
  function setActiveMenu(section){
    menuItems.forEach(li => li.classList.toggle('active', li.dataset.section === section));
  }

  menuItems.forEach(li => {
    li.addEventListener('click', () => {
      const s = li.dataset.section;
      setActiveMenu(s);
      renderSection(s);
    });
  });

  // Inicial
  renderSection('dashboard');

  /* ================== Dashboard (cards + chart) ================== */
  let ventasChart = null;
  function calcularResumen(){
    const pedidos = state.pedidos || [];
    const clientes = state.clientes || [];
    const ingresos = pedidos.reduce((s,p)=> s + (Number(p.total)||0), 0);
    const pendientes = pedidos.filter(p => (p.estado||'').toLowerCase().includes('pend')).length;
    return {
      pedidos: pedidos.length,
      ingresos,
      pendientes,
      clientes: clientes.length,
      ventasMensuales: ventasPorMes(pedidos)
    };
  }
  function ventasPorMes(pedidos){
    const arr = Array(12).fill(0);
    (pedidos||[]).forEach(p => {
      const f = p.fecha ? new Date(p.fecha) : new Date();
      arr[f.getMonth()] += Number(p.total)||0;
    });
    // devolver primeros 10 meses para mostrar como ejemplo
    return arr.slice(0,10);
  }

  function renderCards(){
    const r = calcularResumen();
    cardsRow.innerHTML = `
      <div class="card"><h4>Pedidos del mes</h4><p id="k_pedidos">${r.pedidos}</p></div>
      <div class="card"><h4>Ingresos del mes</h4><p id="k_ingresos">${currency(r.ingresos)}</p></div>
      <div class="card"><h4>Pedidos pendientes</h4><p id="k_pendientes">${r.pendientes}</p></div>
      <div class="card"><h4>Clientes activos</h4><p id="k_clientes">${r.clientes}</p></div>
    `;
  }

  function renderChart(){
    const ctx = document.getElementById('chartVentas').getContext('2d');
    const data = calcularResumen().ventasMensuales;
    if(ventasChart) ventasChart.destroy();
    ventasChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'],
        datasets: [{ label:'Ventas', data, borderColor: '#c62828', backgroundColor:'rgba(198,40,40,0.08)', fill:true, tension:0.3 }]
      },
      options: { responsive:true, plugins:{legend:{display:false}} }
    });
  }

  /* ================== RENDER SECTIONS ================== */
  function renderSection(section){
    state = loadState(); // recarga
    if(section === 'dashboard'){
      document.title = 'Dashboard - Red Stampación';
      renderCards();
      renderChart();
      sectionArea.innerHTML = `
        <div class="panel" style="margin-top:18px">
          <h3>Resumen rápido</h3>
          <p style="color:#666;margin-top:8px">Acciones rápidas: crear pedido, ver inventario y clientes.</p>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn primary" id="quickNewPedido">Nuevo pedido</button>
            <button class="btn ghost" id="goPedidos">Ir a Pedidos</button>
            <button class="btn ghost" id="goInventario">Ir a Inventario</button>
          </div>
        </div>
      `;
      document.getElementById('quickNewPedido').addEventListener('click', ()=> openNuevoPedido());
      document.getElementById('goPedidos').addEventListener('click', ()=> { setActiveMenu('pedidos'); renderSection('pedidos'); });
      document.getElementById('goInventario').addEventListener('click', ()=> { setActiveMenu('inventario'); renderSection('inventario'); });
    }

    else if(section === 'pedidos'){
      document.title = 'Pedidos - Red Stampación';
      renderPedidos();
    }

    else if(section === 'inventario'){
      document.title = 'Inventario - Red Stampación';
      renderInventario();
    }

    else if(section === 'clientes'){
      document.title = 'Clientes - Red Stampación';
      renderClientes();
    }

    else if(section === 'disenos'){
      document.title = 'Diseños - Red Stampación';
      renderDisenos();
    }

    else if(section === 'reportes'){
      document.title = 'Reportes - Red Stampación';
      renderReportes();
    }
  }

  /* ================== PEDIDOS CRUD ================== */
  function renderPedidos(){
    const pedidos = state.pedidos || [];
    sectionArea.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Pedidos</h2>
        <div>
          <button class="btn primary" id="btnNewPedido">Nuevo pedido</button>
          <button class="btn ghost" id="btnBackDash">Volver</button>
        </div>
      </div>

      <div class="controls">
        <input id="q_ped" placeholder="Buscar cliente o producto..." style="padding:8px;border-radius:8px;border:1px solid #e9eef1;width:320px">
        <select id="f_estado" style="padding:8px;border-radius:8px;border:1px solid #e9eef1">
          <option value="">Filtrar estado</option>
          <option>Pendiente</option><option>En proceso</option><option>Entregado</option>
        </select>
      </div>

      <table>
        <thead>
          <tr><th>ID</th><th>Cliente</th><th>Producto</th><th>Total</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tbPedidos">
          ${pedidos.map(p => `
            <tr data-id="${p.id}">
              <td>${p.id}</td>
              <td>${escapeHtml(p.cliente)}</td>
              <td>${escapeHtml(p.producto)}</td>
              <td>${currency(p.total)}</td>
              <td>${escapeHtml(p.estado)}</td>
              <td>${escapeHtml(p.fecha||'')}</td>
              <td class="actions">
                <button class="btn ghost btn-edit" data-id="${p.id}">Editar</button>
                <button class="btn danger btn-del" data-id="${p.id}">Eliminar</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    document.getElementById('btnNewPedido').addEventListener('click', openNuevoPedido);
    document.getElementById('btnBackDash').addEventListener('click', ()=> { setActiveMenu('dashboard'); renderSection('dashboard'); });

    // filtros
    document.getElementById('q_ped').addEventListener('input', aplicarFiltroPedidos);
    document.getElementById('f_estado').addEventListener('change', aplicarFiltroPedidos);

    // bind buttons
    document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', e => {
      openEditarPedido(e.target.dataset.id);
    }));
    document.querySelectorAll('.btn-del').forEach(b => b.addEventListener('click', e => {
      const id = e.target.dataset.id;
      if(confirm('Eliminar pedido?')){
        state.pedidos = state.pedidos.filter(x => x.id !== id);
        saveState(state);
        renderSection('pedidos');
        renderCards(); renderChart();
      }
    }));
  }

  function aplicarFiltroPedidos(){
    const q = (document.getElementById('q_ped').value||'').toLowerCase();
    const f = (document.getElementById('f_estado').value||'').toLowerCase();
    document.querySelectorAll('#tbPedidos tr').forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = (text.includes(q) && (f === '' || text.includes(f))) ? '' : 'none';
    });
  }

  function openNuevoPedido(){
    // producto options from inventory
    const prodOptions = (state.inventario||[]).map(it => `<option value="${escapeHtml(it.producto)}">${escapeHtml(it.producto)}</option>`).join('');
    openModal('Nuevo pedido', `
      <div>
        <div class="form-grid">
          <input id="p_cliente" placeholder="Cliente">
          <select id="p_producto">${prodOptions}<option value="">Otro...</option></select>
          <input id="p_total" type="number" placeholder="Total">
          <select id="p_estado2"><option>Pendiente</option><option>En proceso</option><option>Entregado</option></select>
        </div>
        <div style="margin-top:10px;">
          <label>Fecha</label>
          <input id="p_fecha" type="date" value="${fechaHoy()}">
        </div>
      </div>
    `, () => {
      const cliente = document.getElementById('p_cliente').value.trim();
      const producto = document.getElementById('p_producto').value.trim();
      const total = Number(document.getElementById('p_total').value) || 0;
      const estado = document.getElementById('p_estado2').value;
      const fecha = document.getElementById('p_fecha').value;
      if(!cliente || !producto || total <= 0){ alert('Completa cliente, producto y total válido'); return; }
      state.pedidos.push({ id: genId(), cliente, producto, total, estado, fecha });
      saveState(state);
      closeModal(); renderSection('pedidos'); renderCards(); renderChart();
    });
  }

  function openEditarPedido(id){
    const p = (state.pedidos||[]).find(x => x.id === id);
    if(!p) return alert('Pedido no encontrado');
    const prodOptions = (state.inventario||[]).map(it => `<option ${it.producto===p.producto ? 'selected':''} value="${escapeHtml(it.producto)}">${escapeHtml(it.producto)}</option>`).join('');
    openModal('Editar pedido', `
      <div>
        <div class="form-grid">
          <input id="p_cliente" value="${escapeHtml(p.cliente)}">
          <select id="p_producto">${prodOptions}<option ${p.producto==='' ? 'selected':''} value="">Otro...</option></select>
          <input id="p_total" type="number" value="${p.total}">
          <select id="p_estado2"><option ${p.estado==='Pendiente'?'selected':''}>Pendiente</option><option ${p.estado==='En proceso'?'selected':''}>En proceso</option><option ${p.estado==='Entregado'?'selected':''}>Entregado</option></select>
        </div>
        <div style="margin-top:10px;">
          <label>Fecha</label>
          <input id="p_fecha" type="date" value="${escapeHtml(p.fecha||fechaHoy())}">
        </div>
      </div>
    `, () => {
      p.cliente = document.getElementById('p_cliente').value.trim();
      p.producto = document.getElementById('p_producto').value.trim();
      p.total = Number(document.getElementById('p_total').value) || 0;
      p.estado = document.getElementById('p_estado2').value;
      p.fecha = document.getElementById('p_fecha').value;
      if(!p.cliente || !p.producto || p.total <= 0){ alert('Completa cliente, producto y total válido'); return; }
      saveState(state);
      closeModal(); renderSection('pedidos'); renderCards(); renderChart();
    });
  }

  /* ================== INVENTARIO CRUD ================== */
  function renderInventario(){
    const items = state.inventario || [];
    sectionArea.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Inventario</h2>
        <div>
          <button class="btn primary" id="newInv">Agregar producto</button>
          <button class="btn ghost" id="backDashInv">Volver</button>
        </div>
      </div>

      <div class="controls">
        <input id="q_inv" placeholder="Buscar producto..." style="padding:8px;border-radius:8px;border:1px solid #e9eef1;width:320px">
      </div>

      <table>
        <thead><tr><th>Producto</th><th>Stock</th><th>Precio</th><th>Acciones</th></tr></thead>
        <tbody id="tbInv">
          ${items.map(it => `
            <tr data-id="${it.id}">
              <td>${escapeHtml(it.producto)}</td>
              <td>${it.stock}</td>
              <td>${currency(it.precio)}</td>
              <td class="actions">
                <button class="btn ghost edit-inv" data-id="${it.id}">Editar</button>
                <button class="btn danger del-inv" data-id="${it.id}">Eliminar</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    document.getElementById('newInv').addEventListener('click', openNuevoInventario);
    document.getElementById('backDashInv').addEventListener('click', ()=> { setActiveMenu('dashboard'); renderSection('dashboard'); });
    document.getElementById('q_inv').addEventListener('input', ()=> {
      const q = (document.getElementById('q_inv').value||'').toLowerCase();
      document.querySelectorAll('#tbInv tr').forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    document.querySelectorAll('.edit-inv').forEach(b => b.addEventListener('click', e => openEditarInventario(e.target.dataset.id)));
    document.querySelectorAll('.del-inv').forEach(b => b.addEventListener('click', e => {
      const id = e.target.dataset.id;
      if(confirm('Eliminar producto?')){
        state.inventario = state.inventario.filter(x => x.id !== id);
        saveState(state); renderSection('inventario'); renderCards();
      }
    }));
  }

  function openNuevoInventario(){
    openModal('Nuevo producto', `
      <div>
        <div class="form-grid">
          <input id="i_producto" placeholder="Nombre producto">
          <input id="i_stock" type="number" placeholder="Stock" value="0">
          <input id="i_precio" type="number" placeholder="Precio unitario">
          <input id="i_dummy" placeholder="">
        </div>
      </div>
    `, () => {
      const producto = document.getElementById('i_producto').value.trim();
      const stock = Number(document.getElementById('i_stock').value) || 0;
      const precio = Number(document.getElementById('i_precio').value) || 0;
      if(!producto){ alert('Nombre requerido'); return; }
      state.inventario.push({ id: genId(), producto, stock, precio });
      saveState(state); closeModal(); renderSection('inventario'); renderCards();
    });
  }

  function openEditarInventario(id){
    const it = (state.inventario||[]).find(x => x.id === id);
    if(!it) return alert('Producto no encontrado');
    openModal('Editar producto', `
      <div>
        <div class="form-grid">
          <input id="i_producto" value="${escapeHtml(it.producto)}">
          <input id="i_stock" type="number" value="${it.stock}">
          <input id="i_precio" type="number" value="${it.precio}">
          <input id="i_dummy" placeholder="">
        </div>
      </div>
    `, () => {
      it.producto = document.getElementById('i_producto').value.trim();
      it.stock = Number(document.getElementById('i_stock').value) || 0;
      it.precio = Number(document.getElementById('i_precio').value) || 0;
      if(!it.producto){ alert('Nombre requerido'); return; }
      saveState(state); closeModal(); renderSection('inventario'); renderCards();
    });
  }

  /* ================== CLIENTES CRUD ================== */
  function renderClientes(){
    const clientes = state.clientes || [];
    sectionArea.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Clientes</h2>
        <div>
          <button class="btn primary" id="newCli">Nuevo cliente</button>
          <button class="btn ghost" id="backDashCli">Volver</button>
        </div>
      </div>

      <div class="controls">
        <input id="q_cli" placeholder="Buscar cliente..." style="padding:8px;border-radius:8px;border:1px solid #e9eef1;width:320px">
      </div>

      <table>
        <thead><tr><th>Nombre</th><th>Correo</th><th>Teléfono</th><th>Acciones</th></tr></thead>
        <tbody id="tbCli">
          ${clientes.map(c => `
            <tr data-id="${c.id}">
              <td>${escapeHtml(c.nombre)}</td>
              <td>${escapeHtml(c.correo)}</td>
              <td>${escapeHtml(c.telefono||'')}</td>
              <td class="actions">
                <button class="btn ghost edit-cli" data-id="${c.id}">Editar</button>
                <button class="btn danger del-cli" data-id="${c.id}">Eliminar</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    document.getElementById('newCli').addEventListener('click', openNuevoCliente);
    document.getElementById('backDashCli').addEventListener('click', ()=> { setActiveMenu('dashboard'); renderSection('dashboard'); });
    document.getElementById('q_cli').addEventListener('input', ()=> {
      const q = (document.getElementById('q_cli').value||'').toLowerCase();
      document.querySelectorAll('#tbCli tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
    });

    document.querySelectorAll('.edit-cli').forEach(b => b.addEventListener('click', e => openEditarCliente(e.target.dataset.id)));
    document.querySelectorAll('.del-cli').forEach(b => b.addEventListener('click', e => {
      const id = e.target.dataset.id;
      if(confirm('Eliminar cliente?')){
        state.clientes = state.clientes.filter(x => x.id !== id);
        saveState(state); renderSection('clientes'); renderCards();
      }
    }));
  }

  function openNuevoCliente(){
    openModal('Nuevo cliente', `
      <div>
        <div class="form-grid">
          <input id="c_nombre" placeholder="Nombre completo">
          <input id="c_correo" placeholder="Correo">
          <input id="c_tel" placeholder="Teléfono">
          <input id="c_dummy" placeholder="">
        </div>
      </div>
    `, () => {
      const nombre = document.getElementById('c_nombre').value.trim();
      const correo = document.getElementById('c_correo').value.trim();
      const telefono = document.getElementById('c_tel').value.trim();
      if(!nombre || !correo){ alert('Nombre y correo requeridos'); return; }
      state.clientes.push({ id: genId(), nombre, correo, telefono });
      saveState(state); closeModal(); renderSection('clientes'); renderCards();
    });
  }

  function openEditarCliente(id){
    const c = (state.clientes||[]).find(x => x.id === id);
    if(!c) return alert('Cliente no encontrado');
    openModal('Editar cliente', `
      <div>
        <div class="form-grid">
          <input id="c_nombre" value="${escapeHtml(c.nombre)}">
          <input id="c_correo" value="${escapeHtml(c.correo)}">
          <input id="c_tel" value="${escapeHtml(c.telefono||'')}">
          <input id="c_dummy" placeholder="">
        </div>
      </div>
    `, () => {
      c.nombre = document.getElementById('c_nombre').value.trim();
      c.correo = document.getElementById('c_correo').value.trim();
      c.telefono = document.getElementById('c_tel').value.trim();
      if(!c.nombre || !c.correo){ alert('Nombre y correo requeridos'); return; }
      saveState(state); closeModal(); renderSection('clientes'); renderCards();
    });
  }

  /* ================== DISEÑOS (subir & preview) ================== */
  function renderDisenos(){
    const dis = state.disenos || [];
    sectionArea.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Diseños</h2>
        <div>
          <button class="btn primary" id="newDis">Subir diseño</button>
          <button class="btn ghost" id="backDashDes">Volver</button>
        </div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
        ${dis.length ? dis.map(d => `
          <div style="background:var(--card);padding:10px;border-radius:8px;box-shadow:var(--shadow)">
            <img src="${d.dataUrl}" class="thumb" alt="${escapeHtml(d.nombre)}">
            <div style="margin-top:8px;font-weight:700">${escapeHtml(d.nombre)}</div>
            <div style="color:#666;font-size:13px">${escapeHtml(d.descripcion||'')}</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn ghost edit-design" data-id="${d.id}">Editar</button>
              <button class="btn danger del-design" data-id="${d.id}">Eliminar</button>
            </div>
          </div>
        `).join('') : `<div style="background:var(--card);padding:18px;border-radius:8px;box-shadow:var(--shadow);grid-column:1/-1">No hay diseños. Sube uno.</div>`}
      </div>
    `;
    document.getElementById('newDis').addEventListener('click', openNuevoDiseno);
    document.getElementById('backDashDes').addEventListener('click', ()=> { setActiveMenu('dashboard'); renderSection('dashboard'); });
    document.querySelectorAll('.del-design').forEach(b => b.addEventListener('click', e => {
      const id = e.target.dataset.id;
      if(confirm('Eliminar diseño?')){
        state.disenos = state.disenos.filter(x => x.id !== id);
        saveState(state); renderSection('disenos');
      }
    }));
    document.querySelectorAll('.edit-design').forEach(b => b.addEventListener('click', e => openEditarDiseno(e.target.dataset.id)));
  }

  function openNuevoDiseno(){
    openModal('Subir diseño', `
      <div>
        <div class="form-grid">
          <input id="d_nombre" placeholder="Nombre del diseño">
          <input id="d_file" type="file" accept="image/*">
          <textarea id="d_desc" placeholder="Descripción" style="grid-column:1/-1"></textarea>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <img id="d_preview" class="thumb" src="" style="display:none">
          <div style="color:#666;font-size:13px">Previsualización</div>
        </div>
      </div>
    `, () => {
      const nombre = document.getElementById('d_nombre').value.trim();
      const desc = document.getElementById('d_desc').value.trim();
      const inputFile = document.getElementById('d_file');
      if(!nombre){ alert('Nombre requerido'); return; }
      if(inputFile.files && inputFile.files[0]){
        const file = inputFile.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          const dataUrl = e.target.result;
          state.disenos.push({ id: genId(), nombre, descripcion: desc, dataUrl });
          saveState(state); closeModal(); renderSection('disenos');
        };
        reader.readAsDataURL(file);
      } else {
        alert('Selecciona una imagen para el diseño');
      }
    });

    // preview
    modalContent.querySelector('#d_file').addEventListener('change', function(){
      const f = this.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = e => {
        const img = modalContent.querySelector('#d_preview');
        img.src = e.target.result; img.style.display = 'block';
      };
      r.readAsDataURL(f);
    });
  }

  function openEditarDiseno(id){
    const d = (state.disenos||[]).find(x => x.id === id);
    if(!d) return alert('Diseño no encontrado');
    openModal('Editar diseño', `
      <div>
        <div class="form-grid">
          <input id="d_nombre" value="${escapeHtml(d.nombre)}">
          <input id="d_file" type="file" accept="image/*">
          <textarea id="d_desc">${escapeHtml(d.descripcion||'')}</textarea>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <img id="d_preview" class="thumb" src="${d.dataUrl}">
          <div style="color:#666;font-size:13px">Previsualización</div>
        </div>
      </div>
    `, () => {
      d.nombre = document.getElementById('d_nombre').value.trim();
      d.descripcion = document.getElementById('d_desc').value.trim();
      const input = document.getElementById('d_file');
      if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = e => {
          d.dataUrl = e.target.result;
          saveState(state); closeModal(); renderSection('disenos');
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        saveState(state); closeModal(); renderSection('disenos');
      }
    });

    // preview new file
    modalContent.querySelector('#d_file').addEventListener('change', function(){
      const f = this.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = e => { modalContent.querySelector('#d_preview').src = e.target.result; };
      r.readAsDataURL(f);
    });
  }

  /* ================== REPORTES ================== */
  function renderReportes(){
    sectionArea.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Reportes</h2>
        <div>
          <button class="btn primary" id="expJson">Exportar JSON</button>
          <button class="btn ghost" id="backDashRep">Volver</button>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <label>Desde:</label><input id="r_from" type="date" value="${fechaHoy()}">
        <label>Hasta:</label><input id="r_to" type="date" value="${fechaHoy()}">
        <button class="btn ghost" id="r_filter">Filtrar</button>
      </div>

      <div style="margin-top:12px;background:var(--card);padding:12px;border-radius:8px;box-shadow:var(--shadow)">
        <h4>Ventas totales en rango</h4>
        <div id="r_result" style="margin-top:8px;color:#333">Selecciona rango y filtra.</div>
      </div>
    `;
    document.getElementById('expJson').addEventListener('click', ()=> {
      const blob = new Blob([JSON.stringify(state, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'redstamp_report.json'; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('backDashRep').addEventListener('click', ()=> { setActiveMenu('dashboard'); renderSection('dashboard'); });
    document.getElementById('r_filter').addEventListener('click', ()=> {
      const from = document.getElementById('r_from').value;
      const to = document.getElementById('r_to').value;
      if(!from || !to){ alert('Selecciona fechas válidas'); return; }
      const fDate = new Date(from);
      const tDate = new Date(to);
      const pedidos = (state.pedidos||[]).filter(p => {
        const d = new Date(p.fecha || p._created || new Date());
        return d >= fDate && d <= tDate;
      });
      const total = pedidos.reduce((s,p)=> s + (Number(p.total)||0), 0);
      document.getElementById('r_result').innerHTML = `<strong>${pedidos.length}</strong> pedidos — Total: <strong>${currency(total)}</strong>`;
    });
  }

  /* ================== GLOBAL ACTIONS ================== */
  document.getElementById('btnExport').addEventListener('click', ()=> {
    const blob = new Blob([JSON.stringify(state, null, 2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'redstamp_export.json'; a.click();
    URL.revokeObjectURL(url);
  });
  document.getElementById('btnReset').addEventListener('click', ()=> {
    if(confirm('Resetear todos los datos a estado inicial?')){
      localStorage.removeItem(STORAGE_KEY);
      seedIfEmpty();
      state = loadState();
      setActiveMenu('dashboard');
      renderSection('dashboard');
    }
  });

  globalSearch.addEventListener('input', ()=> {
    const q = (globalSearch.value||'').toLowerCase();
    // simple highlight: if in current table, filter rows
    document.querySelectorAll('tbody tr').forEach(r => {
      r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  // save wrapper and reload state variable
  function saveState(s){
    saveStateInner(s);
    state = s;
  }
  function saveStateInner(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){ return {}; } }

  // Ensure top-level re-render if user changes storage in another tab
  window.addEventListener('storage', ()=> { state = loadState(); renderSection('dashboard'); });

  </script>
</body>
</html>
